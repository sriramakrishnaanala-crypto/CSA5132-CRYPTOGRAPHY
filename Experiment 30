#include <stdio.h>

#define BLOCK 8

// Simple block cipher (XOR with key)
void encrypt(unsigned char *in, unsigned char *out, unsigned char key) {
    for(int i=0;i<BLOCK;i++)
        out[i] = in[i] ^ key;
}

// CBC-MAC (IV = 0)
void CBC_MAC(unsigned char *msg, int blocks,
             unsigned char key, unsigned char *mac) {

    unsigned char temp[BLOCK] = {0};
    unsigned char buffer[BLOCK];

    for(int b=0;b<blocks;b++) {

        for(int i=0;i<BLOCK;i++)
            buffer[i] = msg[b*BLOCK + i] ^ temp[i];

        encrypt(buffer, temp, key);
    }

    for(int i=0;i<BLOCK;i++)
        mac[i] = temp[i];
}

int main() {

    unsigned char key = 5;

    unsigned char X[BLOCK] = {1,2,3,4,5,6,7,8};

    unsigned char T[BLOCK];

    // Compute MAC for one block
    CBC_MAC(X, 1, key, T);

    printf("MAC(X): ");
    for(int i=0;i<BLOCK;i++)
        printf("%d ", T[i]);
    printf("\n");

    // Construct forged message: X || (X XOR T)
    unsigned char forged[2*BLOCK];

    for(int i=0;i<BLOCK;i++) {
        forged[i] = X[i];
        forged[i+BLOCK] = X[i] ^ T[i];
    }

    unsigned char forged_mac[BLOCK];

    CBC_MAC(forged, 2, key, forged_mac);

    printf("MAC(Forged Message): ");
    for(int i=0;i<BLOCK;i++)
        printf("%d ", forged_mac[i]);
    printf("\n");

    return 0;
}
